{% extends "api/layout.html" %} {% block body %}
<h1>Professors</h1>

<form method="get" id="search-form">
  <input
    id="search-input"
    type="text"
    name="q"
    placeholder="Search professors..."
    autocomplete="off"
  />

  <ul id="faculty-list"></ul>
</form>

<ul id="results-list"></ul>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const defaultUrl = "https://nusprofs-api.onrender.com/";
    const resultsList = document.getElementById("results-list");
    const facultyList = document.getElementById("faculty-list");
    const searchInput = document.getElementById("search-input");
    const form = document.getElementById("search-form");

    let nextUrl = null;
    let loading = false;
    let query = "";
    let debounceTimeout;

    // Function to fetch and append results
    async function fetchResults(url, reset = false) {
      if (loading || !url) return;
      loading = true;

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error("Network response was not ok");

        const data = await response.json();
        nextUrl = data.next; // next URL or null

        if (reset) {
          resultsList.innerHTML = ""; // clear previous results
        }

        setTimeout(() => {
          if (data.results.length === 0) {
            const li = document.createElement("li");
            li.innerHTML = `<h2>No results found for "${query}".</h2>`;
            resultsList.appendChild(li);
          }

          data.results.forEach((professor) => {
            const li = document.createElement("li");
            const h2 = document.createElement("h2");
            h2.innerHTML = `<a href="${defaultUrl}professor/${professor.prof_id}">${professor.name}</a> (${professor.average_rating})`;
            li.appendChild(h2);
            resultsList.appendChild(li);
          });
        }, 50);
      } catch (error) {
        console.error("Fetch error:", error);
      } finally {
        loading = false;
      }
    }

    // Load first page with current query (used for new searches)
    function loadFirstPage() {
      query = searchInput.value.trim();
      const url = `${defaultUrl}search?q=${encodeURIComponent(query)}`;
      nextUrl = null;
      fetchResults(url, true); // true = reset results list
    }

    // Infinite scroll handler
    window.addEventListener("scroll", () => {
      if (
        window.innerHeight + window.scrollY >=
          document.body.offsetHeight - 100 &&
        nextUrl &&
        !loading
      ) {
        fetchResults(nextUrl);
      }
    });

    // Initial load on page load
    loadFirstPage();

    // Listen for input changes, debounce to avoid too many requests
    searchInput.addEventListener("input", () => {
      clearTimeout(debounceTimeout);
      debounceTimeout = setTimeout(() => {
        loadFirstPage();
      }, 300);
    });
  });
</script>
{% endblock %}
